#!/usr/bin/env bash

coproc acpi_listen
trap 'kill $COPROC_PID' EXIT

notify_plugged(){ [[ $2 = *ACPI* ]] && dunstbar -o; }

power_menu(){ [[ $2 = "PBTN" ]] && st -c float -g 30x5+600-10 -e bye; }

lockscreen(){
env XSECURELOCK_PASSWORD_PROMPT=time_hex xsecurelock -- systemctl suspend
}

lock_keys(){
   [[ $(<"$HOME/.keylock") = "enable" ]] && state="disable" || state="enable"
   xinput $state 'AT Translated Set 2 keyboard' && printf '%s' "$state" > "$HOME/.keylock"
   dunstify -C 90211; dunstify -r 90210 -t 4000 "" "<b>${state}d </b> ï„œ "
}

handler(){
   case "$1" in
      button/power) power_menu ;;
      button/screenlock) lock_keys ;;
      ac_adapter) notify_plugged ;;
      button/prog1) lockscreen ;;
   esac
}

while read -u "${COPROC[0]}" -a event; do
   handler "${event[@]}"
done

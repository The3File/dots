#!/usr/bin/env bash

launch(){
	IFS=$'\n' read -rd '' -a apps < "$HOME/.desktop_files"
	read -r selection < <(printf '%s\n' "${apps[@]%,*}" | dmenu -i -b -p "$prompt" -fn "$font")
	for i in "${!apps[@]}";{ [[ "${apps[$i]}" = "${selection}",* ]] && app="${apps[$i]#*,}"; }
	exec $app
}

update(){
	for file in /usr/share/applications/*; do
		while read line; do
			[[ $line =~ "Name=" && -z $name ]] && name="${line#*=}" && continue
			[[ $line =~ "Exec=" && -z $exec ]] && exec="${line#*=}" && continue
		done < $file
		apps+=("$name,$exec")
		unset name exec
	done
	printf '%s\n' "${apps[@]}" > "$HOME/.desktop_files"
}

prompt="apps:"
font="ypn envypn:size=14"
[[ $1 = u ]] && update || launch

#!/usr/bin/env bash

git_do(){
	git --git-dir=$HOME/.dotfiles/ --work-tree=$HOME "$@"
}

put_readme(){
	git_do update-index --no-assume-unchanged $HOME/README.md
	cp $HOME/.dotfiles/README.md $HOME/README.md
	git_do add $HOME/README.md
}

get_readme(){
	mv $HOME/README.md $HOME/.dotfiles/
	git_do update-index --assume-unchanged $HOME/README.md
}

push(){
	[[ $changes ]] && commit
	git_do push
	exit 0
}

commit(){
	[[ "$message" ]] || message="$changes"
	git_do commit -am "$message"
}

case_opts(){
	case $1 in
		up) shift; message="$@"; push ;;
		push) put_readme
	esac
}

get_status(){
	changes=$(git_do status --porcelain)
	[[ ! -z $changes ]] && printf '%s\n' "$changes"
}

main(){
	get_status
	[[ $1 ]] || exit

	case_opts "$@"
	git_do "$@"
	get_readme
}

main "$@"
